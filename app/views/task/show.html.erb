<div class="row row-offcanvas row-offcanvas-right">
  <div class="col-xs-12 col-sm-12">
    <p class="pull-right visible-xs">
      <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <div class="jumbotron row">
      <div class="row">
        <h2><%= @task.title %></h2>
        <p>By <%= @task.user.login %></p>
        <p>Due date <%= @task.end_date%> at <%= @task.hour %> h</p>
        <% if @task.time_before_end > 0 && @task.state == "to_do" %>

          <div class="clock col-md-8" style="margin:2em;"></div>
          <div class="col-md-2">
            <% if current_user == @task.user %>
              <%= link_to "Stop Timer", stop_timer_task_path(@task), :class => "btn btn-lg btn-danger stop_timer_button", :role => "button", method: :put %>
            <% end %>
          </div>
          <div class="message"></div>
        <% else %>
          <h1>TIME IS FINISH </h1>
          <%= form_for(@task, url: validation_end_task_path(@task), html: {method: :put,  multipart: true}) do |f|%>
            <div class="field row">
              <div class="col-md-3">
                  <span class="file-input btn btn-block btn-primary btn-file">
                      Choose File &hellip;  <%= file_field_tag :image, :class => "file", :onchange => "readURL(this, 'img_prev');", id: "validation_image"%>
                  </span>
                  <img id="img_prev" class="img_preview" />
              </div>
            </div>
            <div class="actions row">
              <%= f.submit "Upload image", :class => "btn btn-lg btn-primary" %>
            </div>
          <%end%>
        <%end%>
      </div>
      <% if @task.state != "confirmed" %>
        <div class="row col-md-offset-2">
          <div><%= image_tag(@task.cover_image.xxl) %></div>
        </div>
      <%end%>
    </div>
    <% if @task.state == "confirmed" %>
      <div class='row'>
        <div class="col-lg-6"><%= image_tag(@task.cover_image.xxl, :class => "image_100_width") %></div>
        <div class="col-lg-6"><%= image_tag(@task.validation_image.xxl, :class => "image_100_width")  %></div>
      </div>
    <%end%>


    <div class='row'>
      <h3>Boost <%= @task.user.login %> with :</h3>
      <div role="tabpanel">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active">
            <a href="#home" aria-controls="home" role="tab" data-toggle="tab"><%= image_tag("pencil.png", :class => "img_booost") %> With message</a>
          </li>
          <li role="presentation">
            <a href="#profile" aria-controls="profile" role="tab" data-toggle="tab"><%= image_tag("picture.png", :class => "img_booost") %> Photo</a>
          </li>
          <li role="presentation">
            <a href="#messages" aria-controls="messages" role="tab" data-toggle="tab"><%= image_tag("money.png", :class => "img_booost") %> Money</a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="home">
            <%= form_for(@boost, url: text_boost_task_path(@task), html: {method: :post}) do |f|%>
              <%= f.hidden_field :type, :value => "TextBoost" %>
              <div class="field">
                <%= f.label :text %><br />
                <%= f.text_area :text, autofocus: true, size: "24x6" %>
              </div>

              <div class="actions">
                <%= f.submit "send Boost", :class => "btn btn-lg btn-primary" %>
              </div>

            <% end %>
          </div>
          <div role="tabpanel" class="tab-pane" id="profile">
            <%= form_for(@boost, url: picture_boost_task_path(@task), html: {method: :post, multipart: true}) do |f|%>
              <%= f.hidden_field :type, :value => "PictureBoost" %>
              <br/>
              <div class="field row">
                <div class="col-md-3">
                    <span class="file-input btn btn-block btn-primary btn-file">
                        Choose File &hellip;  <%= f.file_field :image, :class => "file", :onchange => "readURL(this, 'img_prev_boost');"%>
                    </span>
                    <img id="img_prev_boost" class="img_preview" />
                </div>
              </div>

              <div class="actions">
                <%= f.submit "send Picture", :class => "btn btn-lg btn-primary" %>
              </div>
            <%end%>
          </div>
          <div role="tabpanel" class="tab-pane" id="messages">
            <%= form_for(@boost, url: money_boost_task_path(@task), html: {method: :post, id: "payment-form"}) do |f|%>
              <%= f.hidden_field :type, :value => "MoneyBoost" %>
              <span class="payment-errors"></span>

              <%= f.radio_button(:money, 100) %>
              <%= label_tag(:one_dollar, "$1") %>
              <%= f.radio_button(:money, 500) %>
              <%= label_tag(:five_dollar, "$5") %>
              <%= f.radio_button(:money, 1000) %>
              <%= label_tag(:ten_dollar, "$10") %>

              <div class="form-row">
                <label>
                  <span>Card Number</span>
                  <input type="text" size="20" data-stripe="number" id="card_number" />
                </label>
              </div>

              <div class="form-row">
                <label>
                  <span>CVC</span>
                  <input type="text" size="4" data-stripe="cvc" id="cvc"/>
                </label>
              </div>

              <div class="form-row">
                <label>
                  <span>Expiration (MM/YYYY)</span>
                  <input type="text" size="2" data-stripe="exp-month" id="exp-month"/>
                </label>
                <span> / </span>
                <input type="text" size="4" data-stripe="exp-year" id="exp-year" />
              </div>

              <div class="actions">
                <%= f.submit "send money", :class => "btn btn-lg btn-primary" %>
              </div>
            <%end%>
          </div>

        </div>

      </div>
      <div class="row">
        <h3>List of boost</h3>
        <h4>Number of boost : <%= @task.boosts.count %> </h4>
        <hr />
        <% @task.boosts.each do |boost|%>
          <div class="row">
            <div class="col-md-2 img_profile_boost">
              <%= image_tag(@task.user.avatar.thumb) %>
            </div>
            <div class="col-md-5">
              <p>
                by <span class="login"><%= boost.user.login.capitalize %></span>
                <%= time_ago_in_words(boost.created_at) %>
              </p>
              <%= boost.content.html_safe%>
            </div>
          </div>
          <hr />
        <% end %>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">

  // This identifies your website in the createToken call below
  Stripe.setPublishableKey('pk_test_umZbkFDV0vblJJX97EuGm9Su');
  // ...
  jQuery(function($) {
    $('#payment-form').submit(function(event) {
      var $form = $(this);

      // Disable the submit button to prevent repeated clicks
      $form.find('button').prop('disabled', true);

      Stripe.card.createToken($form, stripeResponseHandler);

      // Prevent the form from submitting with the default action
      return false;
    });
  });

  function stripeResponseHandler(status, response) {
    var $form = $('#payment-form');

    if (response.error) {
      // Show the errors on the form
      $form.find('.payment-errors').text(response.error.message);
      $form.find('button').prop('disabled', false);
    } else {
      // response contains id and card, which contains additional card details
      var token = response.id;
      // Insert the token into the form so it gets submitted to the server
      $form.append($('<input type="hidden" name="stripeToken" />').val(token));
      // and submit
      $form.get(0).submit();
    }
  };
</script>


<script type="text/javascript">
  var clock;

  $(document).ready(function() {
    var clock;
    var time_in_second = <%= @task.time_before_end %>
    var state = "<%= @task.state %>"
    // var time_in_second = 10.23

    clock = $('.clock').FlipClock({
          clockFace: 'DailyCounter',
          autoStart: false,
          callbacks: {
            stop: function() {
                location.reload()
              }
          }
      });
    clock.setTime(time_in_second);
    clock.setCountdown(true);
    if (time_in_second > 0 && state == "to_do") 
    {
      clock.start();
    }

  });
</script>
